<html onkeypress="keyP(event)" onkeydown="keyD(event)" onkeyup="keyU(event)" oncontextmenu="return false" ondragstart="return false">
    <head>
        <title>Pong</title>
        <style>
            @font-face {
              font-family: "DOSfont";
              src: url("DOSfont.ttf");
            }
            
            html {
                overflow: hidden;
                margin: 0;
            }
            
            body {
                background: black;
                font-family: "DOSfont";
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            canvas#content {
                position: fixed;
                top: 0;
                left: 0;
            }
        </style>
        <script src="basHitTest.js"></script>
        <script src="rand_js.js"></script>
        <script>
            var running = false, gameReady = false;
            var keys = {w: 87, s: 83, up: 38, down: 40};
            var keysDown = {w: false, s: false, up: false, down: false};
            var paddleSpeed = 12;
            var ballSpeedLimit = {xMin: 6, xMax: 12, yMin: 5, yMax: 11};
            var ball = {x: 0, y: 0, xs: 0, ys: 0, oxs: 0, oys: 0};
            var paddleH = 100, paddleW = 15, paddleOffset = 20, ballW = 20;
            var ls = 0, rs = 0, endScore = 11;
            var lpy, lpx, rpy, rpx;
            var c, ctx, wH, wW;
            
            function showMessage(txt) {
                var oldFont = ctx.font; //save old font
                ctx.font = "40px DOSfont";
                var tX = ~~((wW - ctx.measureText(txt).width) / 2); //center in x-dir
                ctx.fillText(txt, tX, wH - paddleOffset);
                ctx.font = oldFont; //restore old font
            }
            
            function gameOver() {
                running = false;
                requestAnimationFrame(function () {
                    var oldMain = main; //backup main function
                    main = function () {}; //replace main with blank to prevent infinite loop
                    drawLoop(); //draw last frame with updated score
                    main = oldMain; //restore main function
                    showMessage("Game over. Press R to reset game.");
                }); //hack: delay so message doesn't get overwritten
            }
            
            function setupGame() {
                newGame(); //init new game
                drawLoop(); //draw first frame
                showMessage("Press P to play/pause the game."); //overlay message text
                gameReady = true; //allow input
            }
            
            function replayGm() {
                running = gameReady = false; //stop game, block input
                requestAnimationFrame(setupGame); //hack: wait until last animation frame is done
            }
            
            function resetBall() {
                ball.x = ~~((wW - ballW) / 2);
                ball.y = ~~((wH - ballW) / 2);
            }
            
            function clamp(n, min, max) {
                if (n < min)
                    return min;
                else if (n > max)
                    return max;
                
                return n;
            }
            
            function main() {
                if (gameReady) {
                    //hit test with paddles
                    var flag = 0;
                    if (ball.xs < 0 && rectOverlap(ball.x, ball.y, ballW, ballW, lpx, lpy, paddleW, paddleH)) {
                        ball.xs = ball.oxs;
                        flag = -1;
                    }
                    else if (ball.xs > 0 && rectOverlap(ball.x, ball.y, ballW, ballW, rpx, rpy, paddleW, paddleH)) {
                        ball.xs = -ball.oxs;
                        flag = 1;
                    }
                    
                    if (flag != 0) {
                        var hitPos = ball.y + ballW / 2 - ((flag == -1) ? lpy : rpy);
                        var bounceAngle = clamp(2 * hitPos / paddleH - 1, -1, 1);
                        ball.ys = bounceAngle * ball.oys;
                    }

                    //move ball
                    ball.x += ball.xs;
                    ball.y += ball.ys;
                    
                    //hit test with walls
                    flag = 0;
                    if (ball.x <= 0 && ball.xs < 0) {
                        flag = 1;
                        ++rs;
                    }
                    else if (ball.x + ballW >= wW && ball.xs > 0) {
                        flag = -1;
                        ++ls;
                    }

                    if (flag != 0) {
                        if ((ls >= endScore || rs >= endScore) && Math.abs(ls - rs) >= 2) { //win: irst to 11 points with at least 2 point lead
                            gameOver();
                            return;
                        }
                        
                        resetBall();
                        
                        ball.xs = flag * ball.oxs;
                        ball.ys = randBool() ? ball.oys : -ball.oys;
                    }

                    if ((ball.y <= 0 && ball.ys < 0) || (ball.y + ballW >= wH && ball.ys > 0))
                        ball.ys *= -1;
                    
                    //move left paddle (w, s)
                    if (keysDown.w && !keysDown.s && lpy > paddleSpeed) lpy -= paddleSpeed;
                    if (keysDown.s && !keysDown.w && lpy + paddleH < wH - paddleSpeed) lpy += paddleSpeed;
                    
                    //move right paddle (up, down)
                    if (keysDown.up && !keysDown.down && rpy > paddleSpeed) rpy -= paddleSpeed;
                    if (keysDown.down && !keysDown.up && rpy + paddleH < wH - paddleSpeed) rpy += paddleSpeed;
                }
            }
            
            function keyU(event) {
                switch (event.which) {
                    case keys.up:
                        keysDown.up = false;
                        break;
                    case keys.down:
                        keysDown.down = false;
                        break;
                    case keys.w:
                        keysDown.w = false;
                        break;
                    case keys.s:
                        keysDown.s = false;
                        break;
                }
            }
            
            function keyD(event) {
                switch (event.which) {
                    case keys.up:
                        keysDown.up = true;
                        break;
                    case keys.down:
                        keysDown.down = true;
                        break;
                    case keys.w:
                        keysDown.w = true;
                        break;
                    case keys.s:
                        keysDown.s = true;
                        break;
                }
            }
            
            function keyP(event) {
                if (gameReady) {
                    switch (String.fromCharCode(event.which).toLowerCase()) {
                        case "p":
                            if (running)
                                running = false;
                            else {
                                running = true;
                                setTimeout(drawLoop, 0); //asynchronously start drawLoop
                            }
                            break;
                        case "r":
                            replayGm();
                            break;
                    }
                }
            }
            
            function drawLoop() {
                ctx.clearRect(0, 0, wW, wH); //erase entire screen
                
                ctx.fillText(ls, ~~(wW / 4 - ctx.measureText(ls).width / 2), 75); //draw left score
                ctx.fillText(rs, ~~(wW * 3 / 4 - ctx.measureText(ls).width / 2), 75); //draw right score
                
                //draw dividing line
                ctx.beginPath();
                ctx.moveTo(~~(wW / 2), 0);
                ctx.lineTo(~~(wW / 2), wH);
                ctx.stroke();
                
                ctx.fillRect(ball.x, ball.y, ballW, ballW); //draw ball
                
                ctx.fillRect(lpx, lpy, paddleW, paddleH); //draw left paddle
                ctx.fillRect(rpx, rpy, paddleW, paddleH); //draw right paddle
                
                main();
                
                if (running)
                    requestAnimationFrame(drawLoop); //run @ VSync
            }
            
            function newGame() {
                resetBall();
                
                ball.oxs = randInt(ballSpeedLimit.xMin, ballSpeedLimit.xMax);
                ball.xs = randBool() ? ball.oxs : -ball.oxs;
                
                ball.oys = randInt(ballSpeedLimit.yMin, ballSpeedLimit.yMax);
                ball.ys = randBool() ? ball.oys : -ball.oys;
                
                lpy = rpy = ~~((wH - paddleH) / 2);
                ls = rs = 0;
            }
            
            function init() {
                c = document.getElementById("content");
                ctx = c.getContext("2d", {alpha: false});
                (window.onresize = function() {
                    wW = c.width = window.innerWidth;
                    wH = c.height = window.innerHeight;
                    lpx = paddleOffset;
                    rpx = wW - paddleOffset - paddleW;
                    
                    ctx.setLineDash([5, 5]);
                    ctx.font = "100px DOSfont";
                    ctx.fillStyle = ctx.strokeStyle = "white";
                    ctx.lineWidth = 5;
                    
                    replayGm();
                })();           
            }
        </script>
    </head>
    <body onload="init()">
        <canvas id="content" moz-opaque></canvas>
        <p style="visibility: hidden;">This text should be hidden. It's used for font preloading only</p>
    </body>
</html>
